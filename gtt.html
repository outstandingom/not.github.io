<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProCut | Find Nearby Salons</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #000;
            --secondary: #8a6d3b;
            --light: #f9f9f9;
            --accent: #ff6b6b;
            --success: #28a745;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: #fff;
            color: var(--primary);
            padding-bottom: 70px;
        }
        
        .header-section {
            background-color: var(--secondary);
            color: white;
            padding: 40px 0 20px;
            position: relative;
            overflow: hidden;
        }
        
        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(135deg, var(--secondary) 0%, #6b5229 100%);
            z-index: 0;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
        }
        
        .logo span {
            color: #ffd700;
        }
        
        .search-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: -30px;
            position: relative;
            z-index: 10;
            margin-bottom: 30px;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            border: none;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #7a5f32;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            border: none;
        }
        
        .salon-card {
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        
        .salon-card:hover {
            box-shadow: 0 5px 20px rgba(138, 109, 59, 0.15);
            transform: translateY(-3px);
            border-color: var(--secondary);
        }
        
        .salon-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .salon-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .salon-distance {
            background-color: var(--light);
            color: var(--secondary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .salon-rating {
            color: #ffc107;
            margin-bottom: 10px;
        }
        
        .salon-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .salon-services {
            margin-top: 10px;
        }
        
        .service-tag {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        .price-tag {
            background-color: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }
        
        #map {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            margin-top: 20px;
            z-index: 1;
        }
        
        .location-permission {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .location-permission i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .distance-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .sort-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .sort-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sort-btn.active {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            background-color: #f8f9fa;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .no-results i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .user-location-info {
            background-color: #e8f5e8;
            border-left: 4px solid var(--success);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .results-count {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 20px;
        }
        
        .map-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .search-card {
                padding: 15px;
            }
            
            .salon-image {
                height: 140px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-secondary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Finding salons near you...</p>
        </div>
    </div>

    <!-- Header Section -->
    <div class="header-section">
        <div class="container">
            <div class="logo">Pro<span>Cut</span></div>
            <h1 class="mb-3">Find Nearby Salons</h1>
            <p class="mb-4">Discover the best salons in your area. Book appointments instantly.</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Search Card -->
        <div class="search-card">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="searchInput" class="form-label fw-bold">Search Salons</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by salon name, service, or area...">
                        <button class="btn btn-primary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Your Location</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary flex-grow-1" id="getLocationBtn">
                            <i class="fas fa-location-arrow"></i> Use My Location
                        </button>
                        <button class="btn btn-secondary" id="manualLocationBtn">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- User Location Info -->
            <div id="userLocationInfo" class="user-location-info" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-map-pin me-2"></i>
                        <span id="locationText">Getting your location...</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshLocationBtn">
                            <i class="fas fa-redo"></i> Refresh
                        </button>
                    </div>
                </div>
                <small class="text-muted" id="coordinatesInfo"></small>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="distanceFilter" class="form-label">Maximum Distance</label>
                    <select class="form-select" id="distanceFilter">
                        <option value="5">5 km</option>
                        <option value="10" selected>10 km</option>
                        <option value="20">20 km</option>
                        <option value="50">50 km</option>
                        <option value="100">100 km</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="serviceFilter" class="form-label">Service Type</label>
                    <select class="form-select" id="serviceFilter">
                        <option value="">All Services</option>
                        <option value="haircut">Haircut</option>
                        <option value="beard">Beard Trim</option>
                        <option value="facial">Facial</option>
                        <option value="hair color">Hair Color</option>
                        <option value="spa">Spa</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="sortFilter" class="form-label">Sort By</label>
                    <select class="form-select" id="sortFilter">
                        <option value="distance">Distance (Near to Far)</option>
                        <option value="name">Name (A-Z)</option>
                        <option value="rating">Rating (High to Low)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div class="map-controls">
                <button class="btn btn-light btn-sm shadow-sm" id="zoomInBtn" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-light btn-sm shadow-sm mt-1" id="zoomOutBtn" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            <div id="map"></div>
        </div>

        <!-- Results Section -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="resultsTitle">Salons Near You</h4>
                    <div class="results-count" id="resultsCount">0 salons found</div>
                </div>

                <div id="salonsList"></div>

                <!-- No Results Message -->
                <div id="noResults" class="no-results" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h4 class="mb-3">No Salons Found</h4>
                    <p class="mb-3">We couldn't find any salons matching your search criteria.</p>
                    <button class="btn btn-primary" id="searchNearbyBtn">
                        <i class="fas fa-location-arrow"></i> Search Nearby Salons
                    </button>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Location Permission Card -->
                <div id="locationPermissionCard" class="location-permission">
                    <i class="fas fa-map-marked-alt"></i>
                    <h5 class="mb-3">Enable Location</h5>
                    <p class="mb-3">To find salons near you, please allow location access.</p>
                    <button class="btn btn-primary w-100" id="enableLocationBtn">
                        <i class="fas fa-location-arrow"></i> Enable Location
                    </button>
                    <small class="text-muted mt-2 d-block">
                        Your location is used only to find nearby salons and is not stored.
                    </small>
                </div>

                <!-- Popular Services -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Popular Services</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge bg-secondary py-2 px-3">Haircut</span>
                            <span class="badge bg-secondary py-2 px-3">Beard Trim</span>
                            <span class="badge bg-secondary py-2 px-3">Facial</span>
                            <span class="badge bg-secondary py-2 px-3">Hair Color</span>
                            <span class="badge bg-secondary py-2 px-3">Spa</span>
                            <span class="badge bg-secondary py-2 px-3">Massage</span>
                        </div>
                    </div>
                </div>

                <!-- Tips Card -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Tips for Searching</h5>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Allow location access for accurate results</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Use specific service names</li>
                            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Check salon hours before booking</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Read reviews for better choices</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://your-supabase-url.supabase.co';
        const SUPABASE_KEY = 'your-supabase-anon-key';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global variables
        let map = null;
        let userLocation = null;
        let userMarker = null;
        let salonMarkers = [];
        let allSalons = [];
        let filteredSalons = [];

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            checkLocationPermission();
        });

        function initializePage() {
            // Initialize map
            initMap();
            
            // Check for saved location
            const savedLocation = localStorage.getItem('userLocation');
            if (savedLocation) {
                userLocation = JSON.parse(savedLocation);
                updateLocationUI();
                searchNearbySalons();
            }
        }

        function initMap() {
            // Default to India center if no location
            const defaultLocation = [20.5937, 78.9629];
            
            map = L.map('map').setView(defaultLocation, 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add zoom controls
            document.getElementById('zoomInBtn').addEventListener('click', () => {
                map.zoomIn();
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', () => {
                map.zoomOut();
            });
        }

        function setupEventListeners() {
            // Location buttons
            document.getElementById('getLocationBtn').addEventListener('click', getUserLocation);
            document.getElementById('enableLocationBtn').addEventListener('click', getUserLocation);
            document.getElementById('manualLocationBtn').addEventListener('click', showManualLocationInput);
            document.getElementById('refreshLocationBtn').addEventListener('click', getUserLocation);
            document.getElementById('searchNearbyBtn').addEventListener('click', searchNearbySalons);
            
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // Filter changes
            document.getElementById('distanceFilter').addEventListener('change', filterAndDisplaySalons);
            document.getElementById('serviceFilter').addEventListener('change', filterAndDisplaySalons);
            document.getElementById('sortFilter').addEventListener('change', filterAndDisplaySalons);
        }

        function checkLocationPermission() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                    if (result.state === 'granted') {
                        getUserLocation();
                    } else if (result.state === 'prompt') {
                        // Show location permission card
                        document.getElementById('locationPermissionCard').style.display = 'block';
                    }
                });
            }
        }

        function getUserLocation() {
            showLoading(true);
            
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                showLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    userLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        timestamp: new Date().getTime()
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    
                    // Update UI
                    updateLocationUI();
                    
                    // Update map
                    updateMapWithUserLocation();
                    
                    // Search for nearby salons
                    await searchNearbySalons();
                    
                    showLoading(false);
                },
                function(error) {
                    showLoading(false);
                    
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access in your browser settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred.';
                    }
                    
                    showToast(errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function updateLocationUI() {
            const locationInfo = document.getElementById('userLocationInfo');
            const locationText = document.getElementById('locationText');
            const coordinatesInfo = document.getElementById('coordinatesInfo');
            
            locationInfo.style.display = 'block';
            document.getElementById('locationPermissionCard').style.display = 'none';
            
            // Try to get address from coordinates
            getAddressFromCoordinates(userLocation.latitude, userLocation.longitude)
                .then(address => {
                    locationText.textContent = address;
                })
                .catch(() => {
                    locationText.textContent = 'Your current location';
                });
            
            coordinatesInfo.textContent = `Lat: ${userLocation.latitude.toFixed(4)}, Lng: ${userLocation.longitude.toFixed(4)}`;
        }

        async function getAddressFromCoordinates(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    let parts = [];
                    
                    if (address.road) parts.push(address.road);
                    if (address.suburb) parts.push(address.suburb);
                    if (address.city || address.town || address.village) {
                        parts.push(address.city || address.town || address.village);
                    }
                    
                    return parts.length > 0 ? parts.join(', ') : 'Your current location';
                }
            } catch (error) {
                console.error('Error getting address:', error);
            }
            
            return 'Your current location';
        }

        function updateMapWithUserLocation() {
            if (!map || !userLocation) return;
            
            // Update map view
            map.setView([userLocation.latitude, userLocation.longitude], 13);
            
            // Clear existing user marker
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Add new user marker
            userMarker = L.marker([userLocation.latitude, userLocation.longitude], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            // Add popup to user marker
            userMarker.bindPopup('<b>Your Location</b>').openPopup();
        }

        async function searchNearbySalons() {
            if (!userLocation) {
                showToast('Please enable location access first', 'warning');
                getUserLocation();
                return;
            }

            showLoading(true);
            
            try {
                // Fetch salons from Supabase
                const { data: salons, error } = await supabase
                    .from('merchants')
                    .select('*')
                    .eq('status', 'active'); // Only fetch active salons
                
                if (error) throw error;
                
                allSalons = salons || [];
                
                // Calculate distances and filter by current distance filter
                const maxDistance = parseInt(document.getElementById('distanceFilter').value);
                filteredSalons = allSalons
                    .map(salon => {
                        const distance = calculateDistance(
                            userLocation.latitude,
                            userLocation.longitude,
                            salon.latitude,
                            salon.longitude
                        );
                        return { ...salon, distance };
                    })
                    .filter(salon => salon.distance <= maxDistance)
                    .sort((a, b) => a.distance - b.distance);
                
                // Update results
                updateResultsTitle('nearby');
                displaySalons();
                updateMapWithSalons();
                
            } catch (error) {
                console.error('Error fetching salons:', error);
                showToast('Error fetching salons. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                // If search is empty, show nearby salons
                searchNearbySalons();
                return;
            }

            if (!userLocation) {
                showToast('Please enable location access for better search results', 'warning');
                getUserLocation();
                return;
            }

            showLoading(true);
            
            // Filter salons based on search term
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            filteredSalons = allSalons
                .filter(salon => {
                    const matchesSearch = 
                        salon.salon_name.toLowerCase().includes(searchTerm) ||
                        (salon.description && salon.description.toLowerCase().includes(searchTerm)) ||
                        (salon.services && salon.services.some(service => 
                            service.name.toLowerCase().includes(searchTerm)
                        )) ||
                        salon.city.toLowerCase().includes(searchTerm) ||
                        salon.address.toLowerCase().includes(searchTerm);
                    
                    if (!matchesSearch) return false;
                    
                    // Calculate distance
                    salon.distance = calculateDistance(
                        userLocation.latitude,
                        userLocation.longitude,
                        salon.latitude,
                        salon.longitude
                    );
                    
                    return salon.distance <= maxDistance;
                })
                .sort((a, b) => {
                    const sortBy = document.getElementById('sortFilter').value;
                    if (sortBy === 'distance') return a.distance - b.distance;
                    if (sortBy === 'name') return a.salon_name.localeCompare(b.salon_name);
                    if (sortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
                    return 0;
                });
            
            // Update results
            updateResultsTitle('search', searchTerm);
            displaySalons();
            updateMapWithSalons();
            
            showLoading(false);
        }

        function filterAndDisplaySalons() {
            const maxDistance = parseInt(document.getElementById('distanceFilter').value);
            const serviceFilter = document.getElementById('serviceFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            // Start with all salons
            let results = allSalons.map(salon => {
                salon.distance = calculateDistance(
                    userLocation.latitude,
                    userLocation.longitude,
                    salon.latitude,
                    salon.longitude
                );
                return salon;
            });
            
            // Apply distance filter
            results = results.filter(salon => salon.distance <= maxDistance);
            
            // Apply service filter if selected
            if (serviceFilter) {
                results = results.filter(salon => 
                    salon.services && salon.services.some(service => 
                        service.name.toLowerCase().includes(serviceFilter.toLowerCase())
                    )
                );
            }
            
            // Apply sorting
            results.sort((a, b) => {
                if (sortBy === 'distance') return a.distance - b.distance;
                if (sortBy === 'name') return a.salon_name.localeCompare(b.salon_name);
                if (sortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
                return 0;
            });
            
            filteredSalons = results;
            displaySalons();
            updateMapWithSalons();
        }

        function displaySalons() {
            const salonsList = document.getElementById('salonsList');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');
            
            resultsCount.textContent = `${filteredSalons.length} salon${filteredSalons.length !== 1 ? 's' : ''} found`;
            
            if (filteredSalons.length === 0) {
                salonsList.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }
            
            noResults.style.display = 'none';
            
            let html = '<div class="row">';
            
            filteredSalons.forEach((salon, index) => {
                const ratingStars = getRatingStars(salon.rating || 4.0);
                const services = salon.services ? salon.services.slice(0, 3) : [];
                
                html += `
                <div class="col-lg-6 mb-4">
                    <div class="salon-card" onclick="viewSalonDetails('${salon.id}')">
                        <span class="distance-badge">${salon.distance.toFixed(1)} km</span>
                        
                        <img src="${salon.image_url || 'https://via.placeholder.com/400x200?text=Salon+Image'}" 
                             alt="${salon.salon_name}" 
                             class="salon-image">
                        
                        <div class="salon-name">${salon.salon_name}</div>
                        
                        <div class="salon-rating">
                            ${ratingStars}
                            <small class="text-muted">(${salon.rating || 'No'} rating)</small>
                        </div>
                        
                        <div class="salon-location">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${salon.city}, ${salon.address.substring(0, 30)}...
                        </div>
                        
                        <div class="salon-services">
                            ${services.map(service => `
                                <span class="service-tag">
                                    ${service.name} - ₹${service.price}
                                </span>
                            `).join('')}
                            ${salon.services && salon.services.length > 3 ? '<span class="service-tag">+ more</span>' : ''}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <i class="far fa-clock me-1"></i>
                                <small>${salon.opening_time} - ${salon.closing_time}</small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); bookAppointment('${salon.id}')">
                                Book Now
                            </button>
                        </div>
                    </div>
                </div>
                `;
                
                // Close row after 2 items for better layout
                if ((index + 1) % 2 === 0) {
                    html += '</div><div class="row">';
                }
            });
            
            html += '</div>';
            salonsList.innerHTML = html;
        }

        function updateMapWithSalons() {
            // Clear existing salon markers
            salonMarkers.forEach(marker => map.removeLayer(marker));
            salonMarkers = [];
            
            // Add markers for filtered salons
            filteredSalons.forEach(salon => {
                const marker = L.marker([salon.latitude, salon.longitude], {
                    icon: L.divIcon({
                        className: 'salon-marker',
                        html: `<div style="background-color: var(--secondary); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);">
                                <i class="fas fa-scissors" style="font-size: 12px;"></i>
                              </div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h6 style="margin: 0 0 5px 0;">${salon.salon_name}</h6>
                        <p style="margin: 0 0 5px 0; font-size: 12px;">
                            <i class="fas fa-map-marker-alt"></i> ${salon.city}
                        </p>
                        <p style="margin: 0 0 5px 0; font-size: 12px;">
                            <i class="fas fa-ruler"></i> ${salon.distance.toFixed(1)} km away
                        </p>
                        <button onclick="viewSalonDetails('${salon.id}')" 
                                style="width: 100%; margin-top: 5px; padding: 5px; background-color: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            View Details
                        </button>
                    </div>
                `);
                
                salonMarkers.push(marker);
            });
            
            // Fit bounds to show all markers if we have any
            if (salonMarkers.length > 0) {
                const group = new L.featureGroup([userMarker, ...salonMarkers].filter(Boolean));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function updateResultsTitle(type, searchTerm = '') {
            const title = document.getElementById('resultsTitle');
            
            switch(type) {
                case 'nearby':
                    title.textContent = 'Salons Near You';
                    break;
                case 'search':
                    title.textContent = `Search Results for "${searchTerm}"`;
                    break;
                default:
                    title.textContent = 'Salons';
            }
        }

        function getRatingStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            
            return stars;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showManualLocationInput() {
            const city = prompt('Enter your city name:');
            if (city) {
                // Geocode the city to get coordinates
                geocodeCity(city);
            }
        }

        async function geocodeCity(city) {
            showLoading(true);
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    userLocation = {
                        latitude: parseFloat(data[0].lat),
                        longitude: parseFloat(data[0].lon),
                        timestamp: new Date().getTime(),
                        city: city
                    };
                    
                    localStorage.setItem('userLocation', JSON.stringify(userLocation));
                    
                    updateLocationUI();
                    updateMapWithUserLocation();
                    searchNearbySalons();
                    
                    showToast(`Location set to ${city}`, 'success');
                } else {
                    showToast('City not found. Please try another city.', 'error');
                }
            } catch (error) {
                console.error('Error geocoding city:', error);
                showToast('Error setting location. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function viewSalonDetails(salonId) {
            // Redirect to salon details page or show modal
            alert(`Viewing details for salon ID: ${salonId}`);
            // In a real app, you would redirect to: window.location.href = `salon-details.html?id=${salonId}`;
        }

        function bookAppointment(salonId) {
            // Redirect to booking page
            alert(`Booking appointment for salon ID: ${salonId}`);
            // In a real app, you would redirect to: window.location.href = `booking.html?salon=${salonId}`;
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'primary'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add to container
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            // Initialize and show
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();
            
            // Remove after hide
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Make functions available globally for onclick handlers
        window.viewSalonDetails = viewSalonDetails;
        window.bookAppointment = bookAppointment;
    </script>
</body>
</html>
